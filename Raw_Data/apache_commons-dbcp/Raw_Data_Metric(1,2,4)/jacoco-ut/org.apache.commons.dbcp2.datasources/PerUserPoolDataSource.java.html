<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PerUserPoolDataSource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache Commons DBCP</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.dbcp2.datasources</a> &gt; <span class="el_source">PerUserPoolDataSource.java</span></div><h1>PerUserPoolDataSource.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.dbcp2.datasources;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.Map;
import java.util.NoSuchElementException;

import javax.naming.NamingException;
import javax.naming.Reference;
import javax.naming.StringRefAddr;
import javax.sql.ConnectionPoolDataSource;

import org.apache.commons.dbcp2.SwallowedExceptionLogger;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.commons.pool2.ObjectPool;
import org.apache.commons.pool2.impl.GenericObjectPool;

/**
 * &lt;p&gt;
 * A pooling &lt;code&gt;DataSource&lt;/code&gt; appropriate for deployment within J2EE environment. There are many configuration
 * options, most of which are defined in the parent class. This datasource uses individual pools per user, and some
 * properties can be set specifically for a given user, if the deployment environment can support initialization of
 * mapped properties. So for example, a pool of admin or write-access Connections can be guaranteed a certain number of
 * connections, separate from a maximum set for users with read-only connections.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * User passwords can be changed without re-initializing the datasource. When a
 * &lt;code&gt;getConnection(userName, password)&lt;/code&gt; request is processed with a password that is different from those used
 * to create connections in the pool associated with &lt;code&gt;userName&lt;/code&gt;, an attempt is made to create a new
 * connection using the supplied password and if this succeeds, the existing pool is cleared and a new pool is created
 * for connections using the new password.
 * &lt;/p&gt;
 *
 * @since 2.0
 */
public class PerUserPoolDataSource extends InstanceKeyDataSource {

    private static final long serialVersionUID = 7872747993848065028L;

<span class="fc" id="L61">    private static final Log log = LogFactory.getLog(PerUserPoolDataSource.class);</span>

    // Per user pool properties
    private Map&lt;String, Boolean&gt; perUserBlockWhenExhausted;
    private Map&lt;String, String&gt; perUserEvictionPolicyClassName;
    private Map&lt;String, Boolean&gt; perUserLifo;
    private Map&lt;String, Integer&gt; perUserMaxIdle;
    private Map&lt;String, Integer&gt; perUserMaxTotal;
    private Map&lt;String, Long&gt; perUserMaxWaitMillis;
    private Map&lt;String, Long&gt; perUserMinEvictableIdleTimeMillis;
    private Map&lt;String, Integer&gt; perUserMinIdle;
    private Map&lt;String, Integer&gt; perUserNumTestsPerEvictionRun;
    private Map&lt;String, Long&gt; perUserSoftMinEvictableIdleTimeMillis;
    private Map&lt;String, Boolean&gt; perUserTestOnCreate;
    private Map&lt;String, Boolean&gt; perUserTestOnBorrow;
    private Map&lt;String, Boolean&gt; perUserTestOnReturn;
    private Map&lt;String, Boolean&gt; perUserTestWhileIdle;
    private Map&lt;String, Long&gt; perUserTimeBetweenEvictionRunsMillis;

    // Per user connection properties
    private Map&lt;String, Boolean&gt; perUserDefaultAutoCommit;
    private Map&lt;String, Integer&gt; perUserDefaultTransactionIsolation;
    private Map&lt;String, Boolean&gt; perUserDefaultReadOnly;

    /**
     * Map to keep track of Pools for a given user.
     */
<span class="fc" id="L88">    private transient Map&lt;PoolKey, PooledConnectionManager&gt; managers = new HashMap&lt;&gt;();</span>

    /**
     * Default no-arg constructor for Serialization.
     */
<span class="fc" id="L93">    public PerUserPoolDataSource() {</span>
<span class="fc" id="L94">    }</span>

    /**
     * Clears pool(s) maintained by this data source.
     *
     * @see org.apache.commons.pool2.ObjectPool#clear()
     * @since 2.3.0
     */
    public void clear() {
<span class="nc bnc" id="L103" title="All 2 branches missed.">        for (final PooledConnectionManager manager : managers.values()) {</span>
            try {
<span class="nc" id="L105">                getCPDSConnectionFactoryPool(manager).clear();</span>
<span class="nc" id="L106">            } catch (final Exception closePoolException) {</span>
                // ignore and try to close others.
<span class="nc" id="L108">            }</span>
<span class="nc" id="L109">        }</span>
<span class="nc" id="L110">        InstanceKeyDataSourceFactory.removeInstance(getInstanceKey());</span>
<span class="nc" id="L111">    }</span>

    /**
     * Closes pool(s) maintained by this data source.
     *
     * @see org.apache.commons.pool2.ObjectPool#close()
     */
    @Override
    public void close() {
<span class="fc bfc" id="L120" title="All 2 branches covered.">        for (final PooledConnectionManager manager : managers.values()) {</span>
            try {
<span class="fc" id="L122">                getCPDSConnectionFactoryPool(manager).close();</span>
<span class="nc" id="L123">            } catch (final Exception closePoolException) {</span>
                // ignore and try to close others.
<span class="fc" id="L125">            }</span>
<span class="fc" id="L126">        }</span>
<span class="fc" id="L127">        InstanceKeyDataSourceFactory.removeInstance(getInstanceKey());</span>
<span class="fc" id="L128">    }</span>

    private HashMap&lt;String, Boolean&gt; createMap() {
        // Should there be a default size different than what this ctor provides?
<span class="fc" id="L132">        return new HashMap&lt;&gt;();</span>
    }

    @Override
    protected PooledConnectionManager getConnectionManager(final UserPassKey upKey) {
<span class="fc" id="L137">        return managers.get(getPoolKey(upKey.getUsername()));</span>
    }

    private ObjectPool&lt;PooledConnectionAndInfo&gt; getCPDSConnectionFactoryPool(final PooledConnectionManager manager) {
<span class="fc" id="L141">        return ((CPDSConnectionFactory) manager).getPool();</span>
    }

    /**
     * Gets the number of active connections in the default pool.
     *
     * @return The number of active connections in the default pool.
     */
    public int getNumActive() {
<span class="fc" id="L150">        return getNumActive(null);</span>
    }

    /**
     * Gets the number of active connections in the pool for a given user.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    @SuppressWarnings(&quot;resource&quot;)
    public int getNumActive(final String userName) {
<span class="fc" id="L162">        final ObjectPool&lt;PooledConnectionAndInfo&gt; pool = getPool(getPoolKey(userName));</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">        return pool == null ? 0 : pool.getNumActive();</span>
    }

    /**
     * Gets the number of idle connections in the default pool.
     *
     * @return The number of idle connections in the default pool.
     */
    public int getNumIdle() {
<span class="fc" id="L172">        return getNumIdle(null);</span>
    }

    /**
     * Gets the number of idle connections in the pool for a given user.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    @SuppressWarnings(&quot;resource&quot;)
    public int getNumIdle(final String userName) {
<span class="fc" id="L184">        final ObjectPool&lt;PooledConnectionAndInfo&gt; pool = getPool(getPoolKey(userName));</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">        return pool == null ? 0 : pool.getNumIdle();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getBlockWhenExhausted()} for the specified user's pool
     * or the default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public boolean getPerUserBlockWhenExhausted(final String userName) {
<span class="fc" id="L197">        Boolean value = null;</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">        if (perUserBlockWhenExhausted != null) {</span>
<span class="fc" id="L199">            value = perUserBlockWhenExhausted.get(userName);</span>
        }
<span class="fc bfc" id="L201" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L202">            return getDefaultBlockWhenExhausted();</span>
        }
<span class="fc" id="L204">        return value.booleanValue();</span>
    }

    /**
     * Gets the user specific default value for {@link Connection#setAutoCommit(boolean)} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public Boolean getPerUserDefaultAutoCommit(final String userName) {
<span class="fc" id="L215">        Boolean value = null;</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">        if (perUserDefaultAutoCommit != null) {</span>
<span class="fc" id="L217">            value = perUserDefaultAutoCommit.get(userName);</span>
        }
<span class="fc" id="L219">        return value;</span>
    }

    /**
     * Gets the user specific default value for {@link Connection#setReadOnly(boolean)} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public Boolean getPerUserDefaultReadOnly(final String userName) {
<span class="fc" id="L230">        Boolean value = null;</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">        if (perUserDefaultReadOnly != null) {</span>
<span class="fc" id="L232">            value = perUserDefaultReadOnly.get(userName);</span>
        }
<span class="fc" id="L234">        return value;</span>
    }

    /**
     * Gets the user specific default value for {@link Connection#setTransactionIsolation(int)} for the specified user's
     * pool.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public Integer getPerUserDefaultTransactionIsolation(final String userName) {
<span class="fc" id="L246">        Integer value = null;</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">        if (perUserDefaultTransactionIsolation != null) {</span>
<span class="fc" id="L248">            value = perUserDefaultTransactionIsolation.get(userName);</span>
        }
<span class="fc" id="L250">        return value;</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getEvictionPolicyClassName()} for the specified user's
     * pool or the default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public String getPerUserEvictionPolicyClassName(final String userName) {
<span class="fc" id="L262">        String value = null;</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">        if (perUserEvictionPolicyClassName != null) {</span>
<span class="fc" id="L264">            value = perUserEvictionPolicyClassName.get(userName);</span>
        }
<span class="fc bfc" id="L266" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L267">            return getDefaultEvictionPolicyClassName();</span>
        }
<span class="fc" id="L269">        return value;</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getLifo()} for the specified user's pool or the default
     * if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public boolean getPerUserLifo(final String userName) {
<span class="fc" id="L281">        Boolean value = null;</span>
<span class="fc bfc" id="L282" title="All 2 branches covered.">        if (perUserLifo != null) {</span>
<span class="fc" id="L283">            value = perUserLifo.get(userName);</span>
        }
<span class="fc bfc" id="L285" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L286">            return getDefaultLifo();</span>
        }
<span class="fc" id="L288">        return value.booleanValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getMaxIdle()} for the specified user's pool or the
     * default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public int getPerUserMaxIdle(final String userName) {
<span class="fc" id="L300">        Integer value = null;</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">        if (perUserMaxIdle != null) {</span>
<span class="fc" id="L302">            value = perUserMaxIdle.get(userName);</span>
        }
<span class="fc bfc" id="L304" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L305">            return getDefaultMaxIdle();</span>
        }
<span class="fc" id="L307">        return value.intValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getMaxTotal()} for the specified user's pool or the
     * default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public int getPerUserMaxTotal(final String userName) {
<span class="fc" id="L319">        Integer value = null;</span>
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">        if (perUserMaxTotal != null) {</span>
<span class="fc" id="L321">            value = perUserMaxTotal.get(userName);</span>
        }
<span class="fc bfc" id="L323" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L324">            return getDefaultMaxTotal();</span>
        }
<span class="fc" id="L326">        return value.intValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getMaxWaitMillis()} for the specified user's pool or
     * the default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public long getPerUserMaxWaitMillis(final String userName) {
<span class="fc" id="L338">        Long value = null;</span>
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">        if (perUserMaxWaitMillis != null) {</span>
<span class="fc" id="L340">            value = perUserMaxWaitMillis.get(userName);</span>
        }
<span class="fc bfc" id="L342" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L343">            return getDefaultMaxWaitMillis();</span>
        }
<span class="fc" id="L345">        return value.longValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getMinEvictableIdleTimeMillis()} for the specified
     * user's pool or the default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public long getPerUserMinEvictableIdleTimeMillis(final String userName) {
<span class="fc" id="L357">        Long value = null;</span>
<span class="fc bfc" id="L358" title="All 2 branches covered.">        if (perUserMinEvictableIdleTimeMillis != null) {</span>
<span class="fc" id="L359">            value = perUserMinEvictableIdleTimeMillis.get(userName);</span>
        }
<span class="fc bfc" id="L361" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L362">            return getDefaultMinEvictableIdleTimeMillis();</span>
        }
<span class="fc" id="L364">        return value.longValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getMinIdle()} for the specified user's pool or the
     * default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public int getPerUserMinIdle(final String userName) {
<span class="fc" id="L376">        Integer value = null;</span>
<span class="fc bfc" id="L377" title="All 2 branches covered.">        if (perUserMinIdle != null) {</span>
<span class="fc" id="L378">            value = perUserMinIdle.get(userName);</span>
        }
<span class="fc bfc" id="L380" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L381">            return getDefaultMinIdle();</span>
        }
<span class="fc" id="L383">        return value.intValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getNumTestsPerEvictionRun()} for the specified user's
     * pool or the default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public int getPerUserNumTestsPerEvictionRun(final String userName) {
<span class="fc" id="L395">        Integer value = null;</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">        if (perUserNumTestsPerEvictionRun != null) {</span>
<span class="fc" id="L397">            value = perUserNumTestsPerEvictionRun.get(userName);</span>
        }
<span class="fc bfc" id="L399" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L400">            return getDefaultNumTestsPerEvictionRun();</span>
        }
<span class="fc" id="L402">        return value.intValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getSoftMinEvictableIdleTimeMillis()} for the specified
     * user's pool or the default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public long getPerUserSoftMinEvictableIdleTimeMillis(final String userName) {
<span class="fc" id="L414">        Long value = null;</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">        if (perUserSoftMinEvictableIdleTimeMillis != null) {</span>
<span class="fc" id="L416">            value = perUserSoftMinEvictableIdleTimeMillis.get(userName);</span>
        }
<span class="fc bfc" id="L418" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L419">            return getDefaultSoftMinEvictableIdleTimeMillis();</span>
        }
<span class="fc" id="L421">        return value.longValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getTestOnBorrow()} for the specified user's pool or the
     * default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public boolean getPerUserTestOnBorrow(final String userName) {
<span class="fc" id="L433">        Boolean value = null;</span>
<span class="fc bfc" id="L434" title="All 2 branches covered.">        if (perUserTestOnBorrow != null) {</span>
<span class="fc" id="L435">            value = perUserTestOnBorrow.get(userName);</span>
        }
<span class="fc bfc" id="L437" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L438">            return getDefaultTestOnBorrow();</span>
        }
<span class="fc" id="L440">        return value.booleanValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getTestOnCreate()} for the specified user's pool or the
     * default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public boolean getPerUserTestOnCreate(final String userName) {
<span class="fc" id="L452">        Boolean value = null;</span>
<span class="fc bfc" id="L453" title="All 2 branches covered.">        if (perUserTestOnCreate != null) {</span>
<span class="fc" id="L454">            value = perUserTestOnCreate.get(userName);</span>
        }
<span class="fc bfc" id="L456" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L457">            return getDefaultTestOnCreate();</span>
        }
<span class="fc" id="L459">        return value.booleanValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getTestOnReturn()} for the specified user's pool or the
     * default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public boolean getPerUserTestOnReturn(final String userName) {
<span class="fc" id="L471">        Boolean value = null;</span>
<span class="fc bfc" id="L472" title="All 2 branches covered.">        if (perUserTestOnReturn != null) {</span>
<span class="fc" id="L473">            value = perUserTestOnReturn.get(userName);</span>
        }
<span class="fc bfc" id="L475" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L476">            return getDefaultTestOnReturn();</span>
        }
<span class="fc" id="L478">        return value.booleanValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getTestWhileIdle()} for the specified user's pool or
     * the default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public boolean getPerUserTestWhileIdle(final String userName) {
<span class="fc" id="L490">        Boolean value = null;</span>
<span class="fc bfc" id="L491" title="All 2 branches covered.">        if (perUserTestWhileIdle != null) {</span>
<span class="fc" id="L492">            value = perUserTestWhileIdle.get(userName);</span>
        }
<span class="fc bfc" id="L494" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L495">            return getDefaultTestWhileIdle();</span>
        }
<span class="fc" id="L497">        return value.booleanValue();</span>
    }

    /**
     * Gets the user specific value for {@link GenericObjectPool#getTimeBetweenEvictionRunsMillis()} for the specified
     * user's pool or the default if no user specific value is defined.
     *
     * @param userName
     *            The user name key.
     * @return The user specific value.
     */
    public long getPerUserTimeBetweenEvictionRunsMillis(final String userName) {
<span class="fc" id="L509">        Long value = null;</span>
<span class="fc bfc" id="L510" title="All 2 branches covered.">        if (perUserTimeBetweenEvictionRunsMillis != null) {</span>
<span class="fc" id="L511">            value = perUserTimeBetweenEvictionRunsMillis.get(userName);</span>
        }
<span class="fc bfc" id="L513" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L514">            return getDefaultTimeBetweenEvictionRunsMillis();</span>
        }
<span class="fc" id="L516">        return value.longValue();</span>
    }

    /**
     * Returns the object pool associated with the given PoolKey.
     *
     * @param poolKey
     *            PoolKey identifying the pool
     * @return the GenericObjectPool pooling connections for the userName and datasource specified by the PoolKey
     */
    private ObjectPool&lt;PooledConnectionAndInfo&gt; getPool(final PoolKey poolKey) {
<span class="fc" id="L527">        final CPDSConnectionFactory mgr = (CPDSConnectionFactory) managers.get(poolKey);</span>
<span class="fc bfc" id="L528" title="All 2 branches covered.">        return mgr == null ? null : mgr.getPool();</span>
    }

    @Override
    protected PooledConnectionAndInfo getPooledConnectionAndInfo(final String userName, final String password)
            throws SQLException {

<span class="fc" id="L535">        final PoolKey key = getPoolKey(userName);</span>
        ObjectPool&lt;PooledConnectionAndInfo&gt; pool;
        PooledConnectionManager manager;
<span class="fc" id="L538">        synchronized (this) {</span>
<span class="fc" id="L539">            manager = managers.get(key);</span>
<span class="fc bfc" id="L540" title="All 2 branches covered.">            if (manager == null) {</span>
                try {
<span class="fc" id="L542">                    registerPool(userName, password);</span>
<span class="fc" id="L543">                    manager = managers.get(key);</span>
<span class="nc" id="L544">                } catch (final NamingException e) {</span>
<span class="nc" id="L545">                    throw new SQLException(&quot;RegisterPool failed&quot;, e);</span>
<span class="fc" id="L546">                }</span>
            }
<span class="fc" id="L548">            pool = getCPDSConnectionFactoryPool(manager);</span>
<span class="fc" id="L549">        }</span>

<span class="fc" id="L551">        PooledConnectionAndInfo info = null;</span>
        try {
<span class="fc" id="L553">            info = pool.borrowObject();</span>
<span class="fc" id="L554">        } catch (final NoSuchElementException ex) {</span>
<span class="fc" id="L555">            throw new SQLException(&quot;Could not retrieve connection info from pool&quot;, ex);</span>
<span class="fc" id="L556">        } catch (final Exception e) {</span>
            // See if failure is due to CPDSConnectionFactory authentication failure
            try {
<span class="fc" id="L559">                testCPDS(userName, password);</span>
<span class="nc" id="L560">            } catch (final Exception ex) {</span>
<span class="nc" id="L561">                throw new SQLException(&quot;Could not retrieve connection info from pool&quot;, ex);</span>
<span class="fc" id="L562">            }</span>
            // New password works, so kill the old pool, create a new one, and borrow
<span class="fc" id="L564">            manager.closePool(userName);</span>
<span class="fc" id="L565">            synchronized (this) {</span>
<span class="fc" id="L566">                managers.remove(key);</span>
<span class="fc" id="L567">            }</span>
            try {
<span class="fc" id="L569">                registerPool(userName, password);</span>
<span class="fc" id="L570">                pool = getPool(key);</span>
<span class="nc" id="L571">            } catch (final NamingException ne) {</span>
<span class="nc" id="L572">                throw new SQLException(&quot;RegisterPool failed&quot;, ne);</span>
<span class="fc" id="L573">            }</span>
            try {
<span class="fc" id="L575">                info = pool.borrowObject();</span>
<span class="nc" id="L576">            } catch (final Exception ex) {</span>
<span class="nc" id="L577">                throw new SQLException(&quot;Could not retrieve connection info from pool&quot;, ex);</span>
<span class="fc" id="L578">            }</span>
<span class="fc" id="L579">        }</span>
<span class="fc" id="L580">        return info;</span>
    }

    /**
     * Creates a pool key from the provided parameters.
     *
     * @param userName
     *            User name
     * @return The pool key
     */
    private PoolKey getPoolKey(final String userName) {
<span class="fc" id="L591">        return new PoolKey(getDataSourceName(), userName);</span>
    }

    /**
     * Returns a &lt;code&gt;PerUserPoolDataSource&lt;/code&gt; {@link Reference}.
     */
    @Override
    public Reference getReference() throws NamingException {
<span class="fc" id="L599">        final Reference ref = new Reference(getClass().getName(), PerUserPoolDataSourceFactory.class.getName(), null);</span>
<span class="fc" id="L600">        ref.add(new StringRefAddr(&quot;instanceKey&quot;, getInstanceKey()));</span>
<span class="fc" id="L601">        return ref;</span>
    }

    /**
     * Supports Serialization interface.
     *
     * @param in
     *            a &lt;code&gt;java.io.ObjectInputStream&lt;/code&gt; value
     * @throws IOException
     *             if an error occurs
     * @throws ClassNotFoundException
     *             if an error occurs
     */
    private void readObject(final ObjectInputStream in) throws IOException, ClassNotFoundException {
        try {
<span class="fc" id="L616">            in.defaultReadObject();</span>
<span class="fc" id="L617">            final PerUserPoolDataSource oldDS = (PerUserPoolDataSource) new PerUserPoolDataSourceFactory()</span>
<span class="fc" id="L618">                    .getObjectInstance(getReference(), null, null, null);</span>
<span class="fc" id="L619">            this.managers = oldDS.managers;</span>
<span class="nc" id="L620">        } catch (final NamingException e) {</span>
<span class="nc" id="L621">            throw new IOException(&quot;NamingException: &quot; + e);</span>
<span class="fc" id="L622">        }</span>
<span class="fc" id="L623">    }</span>

    private synchronized void registerPool(final String userName, final String password)
            throws NamingException, SQLException {

<span class="fc" id="L628">        final ConnectionPoolDataSource cpds = testCPDS(userName, password);</span>

        // Set up the factory we will use (passing the pool associates
        // the factory with the pool, so we do not have to do so
        // explicitly)
<span class="fc" id="L633">        final CPDSConnectionFactory factory = new CPDSConnectionFactory(cpds, getValidationQuery(),</span>
<span class="fc" id="L634">                getValidationQueryTimeout(), isRollbackAfterValidation(), userName, password);</span>
<span class="fc" id="L635">        factory.setMaxConnLifetimeMillis(getMaxConnLifetimeMillis());</span>

        // Create an object pool to contain our PooledConnections
<span class="fc" id="L638">        final GenericObjectPool&lt;PooledConnectionAndInfo&gt; pool = new GenericObjectPool&lt;&gt;(factory);</span>
<span class="fc" id="L639">        factory.setPool(pool);</span>
<span class="fc" id="L640">        pool.setBlockWhenExhausted(getPerUserBlockWhenExhausted(userName));</span>
<span class="fc" id="L641">        pool.setEvictionPolicyClassName(getPerUserEvictionPolicyClassName(userName));</span>
<span class="fc" id="L642">        pool.setLifo(getPerUserLifo(userName));</span>
<span class="fc" id="L643">        pool.setMaxIdle(getPerUserMaxIdle(userName));</span>
<span class="fc" id="L644">        pool.setMaxTotal(getPerUserMaxTotal(userName));</span>
<span class="fc" id="L645">        pool.setMaxWaitMillis(getPerUserMaxWaitMillis(userName));</span>
<span class="fc" id="L646">        pool.setMinEvictableIdleTimeMillis(getPerUserMinEvictableIdleTimeMillis(userName));</span>
<span class="fc" id="L647">        pool.setMinIdle(getPerUserMinIdle(userName));</span>
<span class="fc" id="L648">        pool.setNumTestsPerEvictionRun(getPerUserNumTestsPerEvictionRun(userName));</span>
<span class="fc" id="L649">        pool.setSoftMinEvictableIdleTimeMillis(getPerUserSoftMinEvictableIdleTimeMillis(userName));</span>
<span class="fc" id="L650">        pool.setTestOnCreate(getPerUserTestOnCreate(userName));</span>
<span class="fc" id="L651">        pool.setTestOnBorrow(getPerUserTestOnBorrow(userName));</span>
<span class="fc" id="L652">        pool.setTestOnReturn(getPerUserTestOnReturn(userName));</span>
<span class="fc" id="L653">        pool.setTestWhileIdle(getPerUserTestWhileIdle(userName));</span>
<span class="fc" id="L654">        pool.setTimeBetweenEvictionRunsMillis(getPerUserTimeBetweenEvictionRunsMillis(userName));</span>

<span class="fc" id="L656">        pool.setSwallowedExceptionListener(new SwallowedExceptionLogger(log));</span>

<span class="fc" id="L658">        final Object old = managers.put(getPoolKey(userName), factory);</span>
<span class="pc bpc" id="L659" title="1 of 2 branches missed.">        if (old != null) {</span>
<span class="nc" id="L660">            throw new IllegalStateException(&quot;Pool already contains an entry for this user/password: &quot; + userName);</span>
        }
<span class="fc" id="L662">    }</span>

    void setPerUserBlockWhenExhausted(final Map&lt;String, Boolean&gt; userDefaultBlockWhenExhausted) {
<span class="fc" id="L665">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L666" title="All 2 branches covered.">        if (perUserBlockWhenExhausted == null) {</span>
<span class="fc" id="L667">            perUserBlockWhenExhausted = createMap();</span>
        } else {
<span class="fc" id="L669">            perUserBlockWhenExhausted.clear();</span>
        }
<span class="fc" id="L671">        perUserBlockWhenExhausted.putAll(userDefaultBlockWhenExhausted);</span>
<span class="fc" id="L672">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getBlockWhenExhausted()} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserBlockWhenExhausted(final String userName, final Boolean value) {
<span class="fc" id="L683">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L684" title="All 2 branches covered.">        if (perUserBlockWhenExhausted == null) {</span>
<span class="fc" id="L685">            perUserBlockWhenExhausted = createMap();</span>
        }
<span class="fc" id="L687">        perUserBlockWhenExhausted.put(userName, value);</span>
<span class="fc" id="L688">    }</span>

    void setPerUserDefaultAutoCommit(final Map&lt;String, Boolean&gt; userDefaultAutoCommit) {
<span class="fc" id="L691">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L692" title="All 2 branches covered.">        if (perUserDefaultAutoCommit == null) {</span>
<span class="fc" id="L693">            perUserDefaultAutoCommit = createMap();</span>
        } else {
<span class="fc" id="L695">            perUserDefaultAutoCommit.clear();</span>
        }
<span class="fc" id="L697">        perUserDefaultAutoCommit.putAll(userDefaultAutoCommit);</span>
<span class="fc" id="L698">    }</span>

    /**
     * Sets a user specific default value for {@link Connection#setAutoCommit(boolean)} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserDefaultAutoCommit(final String userName, final Boolean value) {
<span class="fc" id="L709">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L710" title="All 2 branches covered.">        if (perUserDefaultAutoCommit == null) {</span>
<span class="fc" id="L711">            perUserDefaultAutoCommit = createMap();</span>
        }
<span class="fc" id="L713">        perUserDefaultAutoCommit.put(userName, value);</span>
<span class="fc" id="L714">    }</span>

    void setPerUserDefaultReadOnly(final Map&lt;String, Boolean&gt; userDefaultReadOnly) {
<span class="fc" id="L717">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L718" title="All 2 branches covered.">        if (perUserDefaultReadOnly == null) {</span>
<span class="fc" id="L719">            perUserDefaultReadOnly = createMap();</span>
        } else {
<span class="fc" id="L721">            perUserDefaultReadOnly.clear();</span>
        }
<span class="fc" id="L723">        perUserDefaultReadOnly.putAll(userDefaultReadOnly);</span>
<span class="fc" id="L724">    }</span>

    /**
     * Sets a user specific default value for {@link Connection#setReadOnly(boolean)} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserDefaultReadOnly(final String userName, final Boolean value) {
<span class="fc" id="L735">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L736" title="All 2 branches covered.">        if (perUserDefaultReadOnly == null) {</span>
<span class="fc" id="L737">            perUserDefaultReadOnly = createMap();</span>
        }
<span class="fc" id="L739">        perUserDefaultReadOnly.put(userName, value);</span>
<span class="fc" id="L740">    }</span>

    void setPerUserDefaultTransactionIsolation(final Map&lt;String, Integer&gt; userDefaultTransactionIsolation) {
<span class="fc" id="L743">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L744" title="All 2 branches covered.">        if (perUserDefaultTransactionIsolation == null) {</span>
<span class="fc" id="L745">            perUserDefaultTransactionIsolation = new HashMap&lt;&gt;();</span>
        } else {
<span class="fc" id="L747">            perUserDefaultTransactionIsolation.clear();</span>
        }
<span class="fc" id="L749">        perUserDefaultTransactionIsolation.putAll(userDefaultTransactionIsolation);</span>
<span class="fc" id="L750">    }</span>

    /**
     * Sets a user specific default value for {@link Connection#setTransactionIsolation(int)} for the specified user's
     * pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserDefaultTransactionIsolation(final String userName, final Integer value) {
<span class="fc" id="L762">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L763" title="All 2 branches covered.">        if (perUserDefaultTransactionIsolation == null) {</span>
<span class="fc" id="L764">            perUserDefaultTransactionIsolation = new HashMap&lt;&gt;();</span>
        }
<span class="fc" id="L766">        perUserDefaultTransactionIsolation.put(userName, value);</span>
<span class="fc" id="L767">    }</span>

    void setPerUserEvictionPolicyClassName(final Map&lt;String, String&gt; userDefaultEvictionPolicyClassName) {
<span class="fc" id="L770">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L771" title="All 2 branches covered.">        if (perUserEvictionPolicyClassName == null) {</span>
<span class="fc" id="L772">            perUserEvictionPolicyClassName = new HashMap&lt;&gt;();</span>
        } else {
<span class="fc" id="L774">            perUserEvictionPolicyClassName.clear();</span>
        }
<span class="fc" id="L776">        perUserEvictionPolicyClassName.putAll(userDefaultEvictionPolicyClassName);</span>
<span class="fc" id="L777">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getEvictionPolicyClassName()} for the specified user's
     * pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserEvictionPolicyClassName(final String userName, final String value) {
<span class="fc" id="L789">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L790" title="All 2 branches covered.">        if (perUserEvictionPolicyClassName == null) {</span>
<span class="fc" id="L791">            perUserEvictionPolicyClassName = new HashMap&lt;&gt;();</span>
        }
<span class="fc" id="L793">        perUserEvictionPolicyClassName.put(userName, value);</span>
<span class="fc" id="L794">    }</span>

    void setPerUserLifo(final Map&lt;String, Boolean&gt; userDefaultLifo) {
<span class="fc" id="L797">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L798" title="All 2 branches covered.">        if (perUserLifo == null) {</span>
<span class="fc" id="L799">            perUserLifo = createMap();</span>
        } else {
<span class="fc" id="L801">            perUserLifo.clear();</span>
        }
<span class="fc" id="L803">        perUserLifo.putAll(userDefaultLifo);</span>
<span class="fc" id="L804">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getLifo()} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserLifo(final String userName, final Boolean value) {
<span class="fc" id="L815">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L816" title="All 2 branches covered.">        if (perUserLifo == null) {</span>
<span class="fc" id="L817">            perUserLifo = createMap();</span>
        }
<span class="fc" id="L819">        perUserLifo.put(userName, value);</span>
<span class="fc" id="L820">    }</span>

    void setPerUserMaxIdle(final Map&lt;String, Integer&gt; userDefaultMaxIdle) {
<span class="fc" id="L823">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L824" title="All 2 branches covered.">        if (perUserMaxIdle == null) {</span>
<span class="fc" id="L825">            perUserMaxIdle = new HashMap&lt;&gt;();</span>
        } else {
<span class="fc" id="L827">            perUserMaxIdle.clear();</span>
        }
<span class="fc" id="L829">        perUserMaxIdle.putAll(userDefaultMaxIdle);</span>
<span class="fc" id="L830">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getMaxIdle()} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserMaxIdle(final String userName, final Integer value) {
<span class="fc" id="L841">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L842" title="All 2 branches covered.">        if (perUserMaxIdle == null) {</span>
<span class="fc" id="L843">            perUserMaxIdle = new HashMap&lt;&gt;();</span>
        }
<span class="fc" id="L845">        perUserMaxIdle.put(userName, value);</span>
<span class="fc" id="L846">    }</span>

    void setPerUserMaxTotal(final Map&lt;String, Integer&gt; userDefaultMaxTotal) {
<span class="fc" id="L849">        assertInitializationAllowed();</span>
<span class="pc bpc" id="L850" title="1 of 2 branches missed.">        if (perUserMaxTotal == null) {</span>
<span class="nc" id="L851">            perUserMaxTotal = new HashMap&lt;&gt;();</span>
        } else {
<span class="fc" id="L853">            perUserMaxTotal.clear();</span>
        }
<span class="fc" id="L855">        perUserMaxTotal.putAll(userDefaultMaxTotal);</span>
<span class="fc" id="L856">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getMaxTotal()} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserMaxTotal(final String userName, final Integer value) {
<span class="fc" id="L867">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L868" title="All 2 branches covered.">        if (perUserMaxTotal == null) {</span>
<span class="fc" id="L869">            perUserMaxTotal = new HashMap&lt;&gt;();</span>
        }
<span class="fc" id="L871">        perUserMaxTotal.put(userName, value);</span>
<span class="fc" id="L872">    }</span>

    void setPerUserMaxWaitMillis(final Map&lt;String, Long&gt; userDefaultMaxWaitMillis) {
<span class="fc" id="L875">        assertInitializationAllowed();</span>
<span class="pc bpc" id="L876" title="1 of 2 branches missed.">        if (perUserMaxWaitMillis == null) {</span>
<span class="nc" id="L877">            perUserMaxWaitMillis = new HashMap&lt;&gt;();</span>
        } else {
<span class="fc" id="L879">            perUserMaxWaitMillis.clear();</span>
        }
<span class="fc" id="L881">        perUserMaxWaitMillis.putAll(userDefaultMaxWaitMillis);</span>
<span class="fc" id="L882">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getMaxWaitMillis()} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserMaxWaitMillis(final String userName, final Long value) {
<span class="fc" id="L893">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L894" title="All 2 branches covered.">        if (perUserMaxWaitMillis == null) {</span>
<span class="fc" id="L895">            perUserMaxWaitMillis = new HashMap&lt;&gt;();</span>
        }
<span class="fc" id="L897">        perUserMaxWaitMillis.put(userName, value);</span>
<span class="fc" id="L898">    }</span>

    void setPerUserMinEvictableIdleTimeMillis(final Map&lt;String, Long&gt; userDefaultMinEvictableIdleTimeMillis) {
<span class="fc" id="L901">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L902" title="All 2 branches covered.">        if (perUserMinEvictableIdleTimeMillis == null) {</span>
<span class="fc" id="L903">            perUserMinEvictableIdleTimeMillis = new HashMap&lt;&gt;();</span>
        } else {
<span class="fc" id="L905">            perUserMinEvictableIdleTimeMillis.clear();</span>
        }
<span class="fc" id="L907">        perUserMinEvictableIdleTimeMillis.putAll(userDefaultMinEvictableIdleTimeMillis);</span>
<span class="fc" id="L908">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getMinEvictableIdleTimeMillis()} for the specified user's
     * pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserMinEvictableIdleTimeMillis(final String userName, final Long value) {
<span class="fc" id="L920">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L921" title="All 2 branches covered.">        if (perUserMinEvictableIdleTimeMillis == null) {</span>
<span class="fc" id="L922">            perUserMinEvictableIdleTimeMillis = new HashMap&lt;&gt;();</span>
        }
<span class="fc" id="L924">        perUserMinEvictableIdleTimeMillis.put(userName, value);</span>
<span class="fc" id="L925">    }</span>

    void setPerUserMinIdle(final Map&lt;String, Integer&gt; userDefaultMinIdle) {
<span class="fc" id="L928">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L929" title="All 2 branches covered.">        if (perUserMinIdle == null) {</span>
<span class="fc" id="L930">            perUserMinIdle = new HashMap&lt;&gt;();</span>
        } else {
<span class="fc" id="L932">            perUserMinIdle.clear();</span>
        }
<span class="fc" id="L934">        perUserMinIdle.putAll(userDefaultMinIdle);</span>
<span class="fc" id="L935">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getMinIdle()} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserMinIdle(final String userName, final Integer value) {
<span class="fc" id="L946">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L947" title="All 2 branches covered.">        if (perUserMinIdle == null) {</span>
<span class="fc" id="L948">            perUserMinIdle = new HashMap&lt;&gt;();</span>
        }
<span class="fc" id="L950">        perUserMinIdle.put(userName, value);</span>
<span class="fc" id="L951">    }</span>

    void setPerUserNumTestsPerEvictionRun(final Map&lt;String, Integer&gt; userDefaultNumTestsPerEvictionRun) {
<span class="fc" id="L954">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L955" title="All 2 branches covered.">        if (perUserNumTestsPerEvictionRun == null) {</span>
<span class="fc" id="L956">            perUserNumTestsPerEvictionRun = new HashMap&lt;&gt;();</span>
        } else {
<span class="fc" id="L958">            perUserNumTestsPerEvictionRun.clear();</span>
        }
<span class="fc" id="L960">        perUserNumTestsPerEvictionRun.putAll(userDefaultNumTestsPerEvictionRun);</span>
<span class="fc" id="L961">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getNumTestsPerEvictionRun()} for the specified user's
     * pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserNumTestsPerEvictionRun(final String userName, final Integer value) {
<span class="fc" id="L973">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L974" title="All 2 branches covered.">        if (perUserNumTestsPerEvictionRun == null) {</span>
<span class="fc" id="L975">            perUserNumTestsPerEvictionRun = new HashMap&lt;&gt;();</span>
        }
<span class="fc" id="L977">        perUserNumTestsPerEvictionRun.put(userName, value);</span>
<span class="fc" id="L978">    }</span>

    void setPerUserSoftMinEvictableIdleTimeMillis(final Map&lt;String, Long&gt; userDefaultSoftMinEvictableIdleTimeMillis) {
<span class="fc" id="L981">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L982" title="All 2 branches covered.">        if (perUserSoftMinEvictableIdleTimeMillis == null) {</span>
<span class="fc" id="L983">            perUserSoftMinEvictableIdleTimeMillis = new HashMap&lt;&gt;();</span>
        } else {
<span class="fc" id="L985">            perUserSoftMinEvictableIdleTimeMillis.clear();</span>
        }
<span class="fc" id="L987">        perUserSoftMinEvictableIdleTimeMillis.putAll(userDefaultSoftMinEvictableIdleTimeMillis);</span>
<span class="fc" id="L988">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getSoftMinEvictableIdleTimeMillis()} for the specified
     * user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserSoftMinEvictableIdleTimeMillis(final String userName, final Long value) {
<span class="fc" id="L1000">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L1001" title="All 2 branches covered.">        if (perUserSoftMinEvictableIdleTimeMillis == null) {</span>
<span class="fc" id="L1002">            perUserSoftMinEvictableIdleTimeMillis = new HashMap&lt;&gt;();</span>
        }
<span class="fc" id="L1004">        perUserSoftMinEvictableIdleTimeMillis.put(userName, value);</span>
<span class="fc" id="L1005">    }</span>

    void setPerUserTestOnBorrow(final Map&lt;String, Boolean&gt; userDefaultTestOnBorrow) {
<span class="fc" id="L1008">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L1009" title="All 2 branches covered.">        if (perUserTestOnBorrow == null) {</span>
<span class="fc" id="L1010">            perUserTestOnBorrow = createMap();</span>
        } else {
<span class="fc" id="L1012">            perUserTestOnBorrow.clear();</span>
        }
<span class="fc" id="L1014">        perUserTestOnBorrow.putAll(userDefaultTestOnBorrow);</span>
<span class="fc" id="L1015">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getTestOnBorrow()} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserTestOnBorrow(final String userName, final Boolean value) {
<span class="fc" id="L1026">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L1027" title="All 2 branches covered.">        if (perUserTestOnBorrow == null) {</span>
<span class="fc" id="L1028">            perUserTestOnBorrow = createMap();</span>
        }
<span class="fc" id="L1030">        perUserTestOnBorrow.put(userName, value);</span>
<span class="fc" id="L1031">    }</span>

    void setPerUserTestOnCreate(final Map&lt;String, Boolean&gt; userDefaultTestOnCreate) {
<span class="fc" id="L1034">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L1035" title="All 2 branches covered.">        if (perUserTestOnCreate == null) {</span>
<span class="fc" id="L1036">            perUserTestOnCreate = createMap();</span>
        } else {
<span class="fc" id="L1038">            perUserTestOnCreate.clear();</span>
        }
<span class="fc" id="L1040">        perUserTestOnCreate.putAll(userDefaultTestOnCreate);</span>
<span class="fc" id="L1041">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getTestOnCreate()} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserTestOnCreate(final String userName, final Boolean value) {
<span class="fc" id="L1052">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L1053" title="All 2 branches covered.">        if (perUserTestOnCreate == null) {</span>
<span class="fc" id="L1054">            perUserTestOnCreate = createMap();</span>
        }
<span class="fc" id="L1056">        perUserTestOnCreate.put(userName, value);</span>
<span class="fc" id="L1057">    }</span>

    void setPerUserTestOnReturn(final Map&lt;String, Boolean&gt; userDefaultTestOnReturn) {
<span class="fc" id="L1060">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L1061" title="All 2 branches covered.">        if (perUserTestOnReturn == null) {</span>
<span class="fc" id="L1062">            perUserTestOnReturn = createMap();</span>
        } else {
<span class="fc" id="L1064">            perUserTestOnReturn.clear();</span>
        }
<span class="fc" id="L1066">        perUserTestOnReturn.putAll(userDefaultTestOnReturn);</span>
<span class="fc" id="L1067">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getTestOnReturn()} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserTestOnReturn(final String userName, final Boolean value) {
<span class="fc" id="L1078">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L1079" title="All 2 branches covered.">        if (perUserTestOnReturn == null) {</span>
<span class="fc" id="L1080">            perUserTestOnReturn = createMap();</span>
        }
<span class="fc" id="L1082">        perUserTestOnReturn.put(userName, value);</span>
<span class="fc" id="L1083">    }</span>

    void setPerUserTestWhileIdle(final Map&lt;String, Boolean&gt; userDefaultTestWhileIdle) {
<span class="fc" id="L1086">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L1087" title="All 2 branches covered.">        if (perUserTestWhileIdle == null) {</span>
<span class="fc" id="L1088">            perUserTestWhileIdle = createMap();</span>
        } else {
<span class="fc" id="L1090">            perUserTestWhileIdle.clear();</span>
        }
<span class="fc" id="L1092">        perUserTestWhileIdle.putAll(userDefaultTestWhileIdle);</span>
<span class="fc" id="L1093">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getTestWhileIdle()} for the specified user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserTestWhileIdle(final String userName, final Boolean value) {
<span class="fc" id="L1104">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L1105" title="All 2 branches covered.">        if (perUserTestWhileIdle == null) {</span>
<span class="fc" id="L1106">            perUserTestWhileIdle = createMap();</span>
        }
<span class="fc" id="L1108">        perUserTestWhileIdle.put(userName, value);</span>
<span class="fc" id="L1109">    }</span>

    void setPerUserTimeBetweenEvictionRunsMillis(final Map&lt;String, Long&gt; userDefaultTimeBetweenEvictionRunsMillis) {
<span class="fc" id="L1112">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L1113" title="All 2 branches covered.">        if (perUserTimeBetweenEvictionRunsMillis == null) {</span>
<span class="fc" id="L1114">            perUserTimeBetweenEvictionRunsMillis = new HashMap&lt;&gt;();</span>
        } else {
<span class="fc" id="L1116">            perUserTimeBetweenEvictionRunsMillis.clear();</span>
        }
<span class="fc" id="L1118">        perUserTimeBetweenEvictionRunsMillis.putAll(userDefaultTimeBetweenEvictionRunsMillis);</span>
<span class="fc" id="L1119">    }</span>

    /**
     * Sets a user specific value for {@link GenericObjectPool#getTimeBetweenEvictionRunsMillis ()} for the specified
     * user's pool.
     *
     * @param userName
     *            The user name key.
     * @param value
     *            The user specific value.
     */
    public void setPerUserTimeBetweenEvictionRunsMillis(final String userName, final Long value) {
<span class="fc" id="L1131">        assertInitializationAllowed();</span>
<span class="fc bfc" id="L1132" title="All 2 branches covered.">        if (perUserTimeBetweenEvictionRunsMillis == null) {</span>
<span class="fc" id="L1133">            perUserTimeBetweenEvictionRunsMillis = new HashMap&lt;&gt;();</span>
        }
<span class="fc" id="L1135">        perUserTimeBetweenEvictionRunsMillis.put(userName, value);</span>
<span class="fc" id="L1136">    }</span>

    @Override
    protected void setupDefaults(final Connection con, final String userName) throws SQLException {
<span class="fc" id="L1140">        Boolean defaultAutoCommit = isDefaultAutoCommit();</span>
<span class="fc bfc" id="L1141" title="All 2 branches covered.">        if (userName != null) {</span>
<span class="fc" id="L1142">            final Boolean userMax = getPerUserDefaultAutoCommit(userName);</span>
<span class="pc bpc" id="L1143" title="1 of 2 branches missed.">            if (userMax != null) {</span>
<span class="nc" id="L1144">                defaultAutoCommit = userMax;</span>
            }
        }

<span class="fc" id="L1148">        Boolean defaultReadOnly = isDefaultReadOnly();</span>
<span class="fc bfc" id="L1149" title="All 2 branches covered.">        if (userName != null) {</span>
<span class="fc" id="L1150">            final Boolean userMax = getPerUserDefaultReadOnly(userName);</span>
<span class="pc bpc" id="L1151" title="1 of 2 branches missed.">            if (userMax != null) {</span>
<span class="nc" id="L1152">                defaultReadOnly = userMax;</span>
            }
        }

<span class="fc" id="L1156">        int defaultTransactionIsolation = getDefaultTransactionIsolation();</span>
<span class="fc bfc" id="L1157" title="All 2 branches covered.">        if (userName != null) {</span>
<span class="fc" id="L1158">            final Integer userMax = getPerUserDefaultTransactionIsolation(userName);</span>
<span class="pc bpc" id="L1159" title="1 of 2 branches missed.">            if (userMax != null) {</span>
<span class="nc" id="L1160">                defaultTransactionIsolation = userMax.intValue();</span>
            }
        }

<span class="fc bfc" id="L1164" title="All 4 branches covered.">        if (defaultAutoCommit != null &amp;&amp; con.getAutoCommit() != defaultAutoCommit.booleanValue()) {</span>
<span class="fc" id="L1165">            con.setAutoCommit(defaultAutoCommit.booleanValue());</span>
        }

<span class="fc bfc" id="L1168" title="All 2 branches covered.">        if (defaultTransactionIsolation != UNKNOWN_TRANSACTIONISOLATION) {</span>
<span class="fc" id="L1169">            con.setTransactionIsolation(defaultTransactionIsolation);</span>
        }

<span class="pc bpc" id="L1172" title="3 of 4 branches missed.">        if (defaultReadOnly != null &amp;&amp; con.isReadOnly() != defaultReadOnly.booleanValue()) {</span>
<span class="nc" id="L1173">            con.setReadOnly(defaultReadOnly.booleanValue());</span>
        }
<span class="fc" id="L1175">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>